<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Ork Control</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

    :root {
      --bg: #0b0d12;
      --bg-2: #0f1320;
      --panel: #121622;
      --panel-2: #161b2a;
      --border: #232a3f;
      --text: #e8ecf2;
      --muted: #9aa3b2;
      --accent: #ffb84d;
      --accent-2: #6ee7ff;
      --accent-3: #a7f3d0;
      --danger: #ff6b6b;
      --shadow: 0 12px 40px rgba(6, 10, 20, 0.5);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: "Space Grotesk", system-ui, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 80% -10%, rgba(110, 231, 255, 0.16), transparent 60%),
        radial-gradient(800px 400px at 0% 10%, rgba(255, 184, 77, 0.16), transparent 60%),
        linear-gradient(160deg, var(--bg), var(--bg-2));
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: radial-gradient(rgba(255,255,255,0.04) 1px, transparent 1px);
      background-size: 20px 20px;
      pointer-events: none;
      opacity: 0.35;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(14px);
      background: rgba(10, 12, 20, 0.75);
      border-bottom: 1px solid var(--border);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 700;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
    }

    button {
      font-family: inherit;
      background: var(--accent);
      border: none;
      color: #20150a;
      font-weight: 700;
      padding: 8px 14px;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
      box-shadow: 0 6px 16px rgba(255, 184, 77, 0.25);
    }

    button.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    button:hover { transform: translateY(-1px); }

    main {
      display: grid;
      grid-template-columns: 320px minmax(0, 1fr);
      gap: 16px;
      padding: 16px 20px 24px;
      height: calc(100% - 72px);
    }

    aside {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .panel {
      background: linear-gradient(160deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .panel h2 {
      margin: 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 240px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .list.large { max-height: 360px; }

    .item {
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(12, 15, 25, 0.7);
      cursor: pointer;
      transition: border 120ms ease, transform 120ms ease, background 120ms ease;
      animation: rise 240ms ease;
    }

    .item:hover { transform: translateY(-1px); border-color: rgba(110,231,255,0.35); }
    .item.selected { border-color: var(--accent); background: rgba(255, 184, 77, 0.08); }

    .item .title {
      font-weight: 600;
      font-size: 14px;
    }

    .item .meta {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid transparent;
    }

    .ok { background: rgba(25, 89, 56, 0.45); color: #a7f3d0; border-color: rgba(25, 89, 56, 0.7); }
    .pending { background: rgba(82, 72, 26, 0.45); color: #fbd38d; border-color: rgba(82, 72, 26, 0.7); }
    .fail { background: rgba(92, 33, 39, 0.55); color: #fecaca; border-color: rgba(92, 33, 39, 0.7); }

    #detail {
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 16px;
      overflow: hidden;
    }

    .overview {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .overview h3 {
      margin: 0 0 4px 0;
      font-size: 20px;
    }

    .overview .meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 13px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    code {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, monospace;
      font-size: 12px;
      background: rgba(15, 18, 30, 0.7);
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid rgba(35, 42, 63, 0.6);
    }

    .log-block {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(12, 15, 25, 0.6);
      margin-top: 12px;
    }

    .log-title {
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }

    pre {
      margin: 0;
      white-space: pre-wrap;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, monospace;
      font-size: 12px;
      color: #c8d1de;
    }

    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
      margin-bottom: 12px;
    }

    .tab {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .tab.active {
      background: rgba(110, 231, 255, 0.15);
      color: var(--text);
      border-color: rgba(110, 231, 255, 0.45);
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    @keyframes rise {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 1100px) {
      main { grid-template-columns: 1fr; height: auto; }
      .list.large { max-height: 260px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Ork Control</h1>
    <div class="controls">
      <span id="active-workflow" class="pill">Workflow: —</span>
      <button id="run-btn">Run Workflow</button>
      <button id="refresh" class="secondary">Refresh</button>
    </div>
  </header>

  <main>
    <aside>
      <div class="panel">
        <div class="panel-header">
          <h2>Workflows</h2>
          <span id="workflow-count" class="pill">0</span>
        </div>
        <div style="padding: 8px 12px; border-bottom: 1px solid var(--border);">
          <input type="text" id="workflow-search" placeholder="Search workflows..." style="width: 100%; padding: 6px 8px; background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 4px; font-family: inherit;" />
        </div>
        <div id="workflow-list" class="list"></div>
        <div id="workflow-pagination" style="padding: 8px 12px; border-top: 1px solid var(--border); text-align: center; font-size: 14px;"></div>
      </div>
      <div class="panel">
        <div class="panel-header">
          <h2>Run History</h2>
          <span id="run-count" class="pill">0</span>
        </div>
        <div style="padding: 8px 12px; border-bottom: 1px solid var(--border); display: flex; gap: 8px;">
          <select id="run-status-filter" style="flex: 1; padding: 6px 8px; background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 4px; font-family: inherit;">
            <option value="">All statuses</option>
            <option value="pending">Pending</option>
            <option value="running">Running</option>
            <option value="paused">Paused</option>
            <option value="success">Success</option>
            <option value="failed">Failed</option>
            <option value="cancelled">Cancelled</option>
          </select>
          <select id="run-workflow-filter" style="flex: 1; padding: 6px 8px; background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 4px; font-family: inherit;">
            <option value="">All workflows</option>
          </select>
        </div>
        <div id="runs-list" class="list large"></div>
        <div id="runs-pagination" style="padding: 8px 12px; border-top: 1px solid var(--border); text-align: center; font-size: 14px;"></div>
      </div>
    </aside>

    <section id="detail">
      <div class="panel">
        <div class="overview">
          <div>
            <h3 id="run-title">No run selected</h3>
            <div class="meta" id="run-meta"></div>
          </div>
          <div id="run-status"></div>
        </div>
      </div>

      <div class="panel" style="overflow:auto;">
        <div class="tabs">
          <button id="tab-run" class="tab active" data-tab="run">Run</button>
          <button id="tab-graph" class="tab" data-tab="graph">Workflow Graph</button>
        </div>
        <div id="tab-content-run" class="tab-panel active">
          <div id="run-graph" style="margin-bottom: 12px;"></div>
          <div id="run-detail">
            <p style="color: var(--muted);">Select a run to view task details.</p>
          </div>
        </div>
        <div id="tab-content-graph" class="tab-panel">
          <div class="panel-header">
            <h2>Workflow graph</h2>
            <span class="pill">static structure</span>
          </div>
          <div id="workflow-graph"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    let selectedWorkflow = null;
    let selectedRunId = null;
    let workflows = [];
    let runs = [];
    let workflowGraph = [];
    let workflowDetail = null;
    let detailInterval = null;
    let lastRunsHash = '';
    let lastWorkflowsHash = '';

    // Pagination and filter state
    let workflowsPage = 0;
    let workflowsTotalPages = 0;
    let workflowsTotal = 0;
    let workflowSearch = '';
    let runsPage = 0;
    let runsTotalPages = 0;
    let runsTotal = 0;
    let runsStatusFilter = '';
    let runsWorkflowFilter = '';
    const WORKFLOWS_PER_PAGE = 50;
    const RUNS_PER_PAGE = 50;
    const MIN_POLL_MS = 100;
    const MAX_POLL_MS = 5000;

    function queryInt(name, fallback) {
      const raw = new URLSearchParams(window.location.search).get(name);
      if (!raw) return fallback;
      const parsed = parseInt(raw, 10);
      if (Number.isNaN(parsed)) return fallback;
      return Math.min(MAX_POLL_MS, Math.max(MIN_POLL_MS, parsed));
    }

    const RUNS_POLL_MS = queryInt('runs_poll_ms', 250);
    const WORKFLOWS_POLL_MS = queryInt('workflows_poll_ms', 1000);
    const DETAIL_POLL_MS = queryInt('detail_poll_ms', 250);
    const WS_RECONNECT_MS = queryInt('ws_reconnect_ms', 1000);
    let workflowsFetchInFlight = false;
    let runsFetchInFlight = false;
    let runDetailFetchInFlightFor = null;

    const workflowListEl = document.getElementById('workflow-list');
    const runsListEl = document.getElementById('runs-list');
    const workflowCountEl = document.getElementById('workflow-count');
    const runCountEl = document.getElementById('run-count');
    const activeWorkflowEl = document.getElementById('active-workflow');
    const runTitleEl = document.getElementById('run-title');
    const runMetaEl = document.getElementById('run-meta');
    const runStatusEl = document.getElementById('run-status');
    const tabRunBtn = document.getElementById('tab-run');
    const tabGraphBtn = document.getElementById('tab-graph');
    const tabRunPanel = document.getElementById('tab-content-run');
    const tabGraphPanel = document.getElementById('tab-content-graph');

    document.getElementById('refresh').onclick = () => {
      fetchWorkflows();
      fetchRuns();
    };
    document.getElementById('run-btn').onclick = () => triggerRun();
    tabRunBtn.onclick = () => setActiveTab('run');
    tabGraphBtn.onclick = () => setActiveTab('graph');

    // Filter event listeners
    let searchTimeout;
    document.getElementById('workflow-search').oninput = (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        workflowSearch = e.target.value;
        workflowsPage = 0;
        fetchWorkflows();
      }, 300);
    };

    document.getElementById('run-status-filter').onchange = (e) => {
      runsStatusFilter = e.target.value;
      runsPage = 0;
      fetchRuns();
    };

    document.getElementById('run-workflow-filter').onchange = (e) => {
      runsWorkflowFilter = e.target.value;
      runsPage = 0;
      fetchRuns();
    };

    // WebSocket connection for real-time updates
    let ws = null;
    let wsReconnectTimeout = null;

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws`;

      try {
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          console.log('WebSocket connected');
          if (wsReconnectTimeout) {
            clearTimeout(wsReconnectTimeout);
            wsReconnectTimeout = null;
          }
        };

        ws.onmessage = (event) => {
          try {
            const update = JSON.parse(event.data);
            if (update.type === 'run_updated') {
              // Refresh runs list when a run is updated
              fetchRuns();
              if (selectedRunId === update.run_id) {
                fetchRunDetail(selectedRunId);
              }
            } else if (update.type === 'task_updated') {
              // Refresh run detail if we're viewing this run
              if (selectedRunId === update.run_id) {
                fetchRunDetail(selectedRunId);
              }
            }
          } catch (e) {
            console.error('Failed to parse WebSocket message:', e);
          }
        };

        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
        };

        ws.onclose = () => {
          console.log(`WebSocket disconnected, reconnecting in ${WS_RECONNECT_MS}ms...`);
          ws = null;
          wsReconnectTimeout = setTimeout(connectWebSocket, WS_RECONNECT_MS);
        };
      } catch (e) {
        console.error('Failed to create WebSocket:', e);
        wsReconnectTimeout = setTimeout(connectWebSocket, WS_RECONNECT_MS);
      }
    }

    connectWebSocket();
    fetchWorkflows();
    fetchRuns();
    setInterval(fetchWorkflows, WORKFLOWS_POLL_MS);
    setInterval(fetchRuns, RUNS_POLL_MS);

    function fetchWorkflows() {
      if (workflowsFetchInFlight) return;
      workflowsFetchInFlight = true;
      const params = new URLSearchParams({
        limit: WORKFLOWS_PER_PAGE,
        offset: workflowsPage * WORKFLOWS_PER_PAGE,
      });
      if (workflowSearch) params.set('search', workflowSearch);

      fetch('/api/workflows?' + params)
        .then(r => r.json())
        .then(data => {
          workflows = data.items || [];
          workflowsTotal = data.total || 0;
          workflowsTotalPages = Math.ceil(workflowsTotal / WORKFLOWS_PER_PAGE);
          if (!selectedWorkflow && workflows.length) {
            selectedWorkflow = workflows[0].name;
            fetchWorkflowGraph(selectedWorkflow);
          }
          renderWorkflows();
          renderRuns();
        })
        .catch(() => {})
        .finally(() => {
          workflowsFetchInFlight = false;
        });
    }

    function fetchRuns() {
      if (runsFetchInFlight) return;
      runsFetchInFlight = true;
      const params = new URLSearchParams({
        limit: RUNS_PER_PAGE,
        offset: runsPage * RUNS_PER_PAGE,
      });
      if (runsStatusFilter) params.set('status', runsStatusFilter);
      if (runsWorkflowFilter) params.set('workflow', runsWorkflowFilter);

      fetch('/api/runs?' + params)
        .then(r => r.json())
        .then(data => {
          runs = data.items || [];
          runsTotal = data.total || 0;
          runsTotalPages = Math.ceil(runsTotal / RUNS_PER_PAGE);
          renderRuns();
          renderWorkflows();
        })
        .catch(() => {})
        .finally(() => {
          runsFetchInFlight = false;
        });
    }

    function fetchWorkflowGraph(name) {
      if (!name) return;
      fetch('/api/workflows/' + encodeURIComponent(name))
        .then(r => r.json())
        .then(data => {
          workflowDetail = data.workflow || null;
          workflowGraph = data.tasks.map(t => ({ id: t.name, deps: t.depends_on || [] }));
          renderWorkflowGraph();
        })
        .catch(() => {});
    }

    function selectWorkflow(name) {
      selectedWorkflow = name;
      selectedRunId = null;
      if (detailInterval) clearInterval(detailInterval);
      detailInterval = null;
      activeWorkflowEl.textContent = `Workflow: ${name || '—'}`;
      renderWorkflows();
      renderRuns();
      fetchWorkflowGraph(name);
      setActiveTab('graph');
    }

    function selectRun(id) {
      selectedRunId = id;
      renderRuns();
      fetchRunDetail(id);
      if (detailInterval) clearInterval(detailInterval);
      detailInterval = setInterval(() => fetchRunDetail(id), DETAIL_POLL_MS);
      setActiveTab('run');
    }

    function renderWorkflows() {
      workflowCountEl.textContent = workflowsTotal;
      activeWorkflowEl.textContent = `Workflow: ${selectedWorkflow || '—'}`;
      if (!workflows.length) {
        workflowListEl.innerHTML = '<p style="color: var(--muted);">No workflows found.</p>';
        document.getElementById('workflow-pagination').innerHTML = '';
        return;
      }

      const list = workflows.map(wf => {
        const wfRuns = runs.filter(r => r.workflow === wf.name).sort((a, b) => {
          return new Date(b.created_at) - new Date(a.created_at);
        });
        const last = wfRuns[0];
        const status = last ? badge(last.status) : '<span class="badge pending">no runs</span>';
        const time = last ? fmtDateTime(last.started_at || last.created_at) : '—';
        let scheduleInfo = '';
        if (wf.schedule_enabled && wf.schedule) {
          const nextRun = wf.next_scheduled_at ? fmtDateTime(wf.next_scheduled_at) : 'calculating...';
          scheduleInfo = `<span style="color: var(--accent-3);">⏰ next: ${nextRun}</span>`;
        }
        return `
          <div class="item ${wf.name === selectedWorkflow ? 'selected' : ''}" data-workflow="${wf.name}">
            <div class="title">${wf.name}</div>
            <div class="meta">${status}<span>last run: ${time}</span>${scheduleInfo}</div>
          </div>
        `;
      }).join('');
      const hash = list;
      if (hash === lastWorkflowsHash && workflowListEl.children.length === workflows.length) {
        return;
      }
      lastWorkflowsHash = hash;

      workflowListEl.innerHTML = list;
      workflowListEl.querySelectorAll('.item').forEach(el => {
        el.onclick = () => selectWorkflow(el.dataset.workflow);
      });

      // Render pagination
      renderPagination('workflow', workflowsPage, workflowsTotalPages, (page) => {
        workflowsPage = page;
        fetchWorkflows();
      });
    }

    function renderRuns() {
      const filtered = selectedWorkflow
        ? runs.filter(r => r.workflow === selectedWorkflow)
        : runs;
      runCountEl.textContent = runsTotal;

      if (selectedRunId && !filtered.some(r => r.id === selectedRunId)) {
        selectedRunId = null;
      }

      if (!filtered.length) {
        runsListEl.innerHTML = '<p style="color: var(--muted);">No runs yet.</p>';
        document.getElementById('runs-pagination').innerHTML = '';
        return;
      }

      const hash = filtered.map(r => `${r.id}|${r.status}|${r.created_at}`).join(',');
      if (hash === lastRunsHash && runsListEl.children.length === filtered.length) {
        return;
      }
      lastRunsHash = hash;

      const list = filtered.map(run => {
        const started = run.started_at || run.created_at;
        const duration = fmtDuration(run.started_at, run.finished_at);
        return `
          <div class="item ${run.id === selectedRunId ? 'selected' : ''}" data-id="${run.id}">
            <div class="title">${run.id}</div>
            <div class="meta">
              ${badge(run.status)}
              <span>Started: ${fmtDateTime(started)}</span>
              <span>Duration: ${duration || '—'}</span>
            </div>
          </div>
        `;
      }).join('');

      runsListEl.innerHTML = list;
      runsListEl.querySelectorAll('.item').forEach(el => {
        el.onclick = () => selectRun(el.dataset.id);
      });

      // Render pagination
      renderPagination('runs', runsPage, runsTotalPages, (page) => {
        runsPage = page;
        fetchRuns();
      });

      // Update workflow filter dropdown options
      updateWorkflowFilterOptions();

      if (!selectedRunId && filtered.length) {
        selectRun(filtered[0].id);
      }
    }

    function fetchRunDetail(id) {
      if (!id) return;
      if (runDetailFetchInFlightFor === id) return;
      runDetailFetchInFlightFor = id;
      fetch('/api/runs/' + id)
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          if (!data) return;
          showDetail(data);
        })
        .catch(() => {})
        .finally(() => {
          if (runDetailFetchInFlightFor === id) {
            runDetailFetchInFlightFor = null;
          }
        });
    }

    function triggerRun() {
      if (!selectedWorkflow) return;
      fetch('/api/runs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ workflow: selectedWorkflow })
      }).then(r => r.json()).then(resp => {
        if (resp.run_id) {
          selectRun(resp.run_id);
          fetchRuns();
        }
      }).catch(() => {});
    }

    function cancelRun(runId) {
      if (!confirm('Are you sure you want to cancel this run?')) return;
      fetch('/api/runs/' + runId + '/cancel', {
        method: 'POST'
      }).then(r => {
        if (r.ok) {
          fetchRunDetail(runId);
          fetchRuns();
        }
      }).catch(() => {});
    }

    function pauseRun(runId) {
      fetch('/api/runs/' + runId + '/pause', {
        method: 'POST'
      }).then(r => {
        if (r.ok) {
          fetchRunDetail(runId);
          fetchRuns();
        }
      }).catch(() => {});
    }

    function resumeRun(runId) {
      fetch('/api/runs/' + runId + '/resume', {
        method: 'POST'
      }).then(r => {
        if (r.ok) {
          fetchRunDetail(runId);
          fetchRuns();
        }
      }).catch(() => {});
    }

    function showDetail(data) {
      if (data.workflow && data.workflow.tasks && data.workflow.tasks.length) {
        workflowGraph = data.workflow.tasks.map(t => ({ id: t.name, deps: t.depends_on || [] }));
      } else if (data.tasks && data.tasks.length) {
        workflowGraph = data.tasks.map(t => ({ id: t.name, deps: t.depends_on || [] }));
      }

      if (!selectedWorkflow && data.run && data.run.workflow) {
        selectedWorkflow = data.run.workflow;
        activeWorkflowEl.textContent = `Workflow: ${selectedWorkflow}`;
      }

      renderWorkflowGraph();

      runTitleEl.textContent = `Run ${data.run.id}`;
      const status = (data.run.status || '').toLowerCase();
      const showPauseBtn = status === 'pending' || status === 'running';
      const showResumeBtn = status === 'paused';
      const showCancelBtn = status === 'pending' || status === 'running' || status === 'paused';
      const pauseBtn = showPauseBtn ? `<button onclick="pauseRun('${data.run.id}')" style="margin-left: 8px; padding: 4px 12px; background: #9a6b2f; color: white; border: none; border-radius: 4px; cursor: pointer;">Pause</button>` : '';
      const resumeBtn = showResumeBtn ? `<button onclick="resumeRun('${data.run.id}')" style="margin-left: 8px; padding: 4px 12px; background: #2f7a5a; color: white; border: none; border-radius: 4px; cursor: pointer;">Resume</button>` : '';
      const cancelBtn = showCancelBtn ? `<button onclick="cancelRun('${data.run.id}')" style="margin-left: 8px; padding: 4px 12px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>` : '';
      runStatusEl.innerHTML = badge(data.run.status) + pauseBtn + resumeBtn + cancelBtn;
      const meta = [
        `Workflow: ${data.run.workflow}`,
        `Created: ${fmtDateTime(data.run.created_at)}`,
        `Started: ${data.run.started_at ? fmtDateTime(data.run.started_at) : '—'}`,
        `Duration: ${fmtDuration(data.run.started_at, data.run.finished_at) || '—'}`
      ];
      runMetaEl.innerHTML = meta.map(m => `<span>${m}</span>`).join('');

      const displayTasks = (data.tasks && data.tasks.length)
        ? data.tasks.map(t => ({ ...t }))
        : (data.workflow && data.workflow.tasks ? data.workflow.tasks.map(t => ({
            id: t.name,
            name: t.name,
            status: 'pending',
            executor: t.executor,
            depends_on: t.depends_on,
            started_at: null,
            finished_at: null,
            dispatched_at: null,
            output: null,
            logs: null,
            error: null
          })) : []);

      const taskRows = displayTasks.map(t => `
        <tr>
          <td>${t.name}</td>
          <td>${badge(t.status)}</td>
          <td>${fmtDateTime(t.started_at)}</td>
          <td>${fmtDateTime(t.finished_at)}</td>
          <td>${fmtDuration(t.started_at, t.finished_at)}</td>
          <td><code>${truncate(JSON.stringify(t.output ?? {}), 120)}</code></td>
        </tr>
      `).join('');

      const logsHtml = displayTasks.map(t => {
        const logs = t.logs ? escapeHtml(t.logs) : '';
        const body = logs ? `<pre>${logs}</pre>` : `<p style="color: var(--muted);">No logs yet.</p>`;
        return `
          <div class="log-block">
            <div class="log-title">${t.name} logs</div>
            ${body}
          </div>
        `;
      }).join('');

      const statusMap = Object.fromEntries(displayTasks.map(t => [t.name, t.status]));
      const graphNodes = workflowGraph.length
        ? workflowGraph
        : displayTasks.map(t => ({ id: t.name, deps: t.depends_on || [] }));
      const graphSvg = renderGraph(graphNodes, statusMap);

      const html = `
        <table>
          <thead>
            <tr><th>Task</th><th>Status</th><th>Started</th><th>Finished</th><th>Duration</th><th>Output</th></tr>
          </thead>
          <tbody>${taskRows}</tbody>
        </table>
        ${logsHtml}
      `;
      document.getElementById('run-graph').innerHTML = graphSvg || '<p style="color: var(--muted);">No graph data.</p>';
      document.getElementById('run-detail').innerHTML = html;
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function setActiveTab(tab) {
      const isRun = tab === 'run';
      tabRunBtn.classList.toggle('active', isRun);
      tabGraphBtn.classList.toggle('active', !isRun);
      tabRunPanel.classList.toggle('active', isRun);
      tabGraphPanel.classList.toggle('active', !isRun);
    }

    function badge(status) {
      const lower = (status || '').toLowerCase();
      const cls = lower === 'success'
        ? 'ok'
        : (lower === 'running' || lower === 'pending' || lower === 'paused' || lower === 'dispatched'
          ? 'pending'
          : 'fail');
      return `<span class="badge ${cls}">${status}</span>`;
    }

    function fmtDateTime(val) {
      if (!val) return '—';
      const d = new Date(val);
      if (isNaN(d.getTime())) return val;
      return d.toLocaleString([], {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function fmtDuration(start, end) {
      const s = start ? new Date(start) : null;
      const e = end ? new Date(end) : new Date();
      if (!s || isNaN(s.getTime())) return '';
      if (isNaN(e.getTime())) return '';
      const ms = e - s;
      if (ms < 0) return '';
      const secs = ms / 1000;
      if (secs < 60) return secs.toFixed(1) + 's';
      const mins = Math.floor(secs / 60);
      const rem = (secs % 60);
      return `${mins}m ${rem.toFixed(1)}s`;
    }

    function truncate(str, len) {
      return str.length > len ? str.slice(0, len) + '…' : str;
    }

    function renderWorkflowGraph() {
      const target = document.getElementById('workflow-graph');
      if (!target) return;
      if (!workflowGraph.length) {
        target.innerHTML = '<p style="color: var(--muted);">No workflow loaded.</p>';
        return;
      }
      let scheduleHtml = '';
      if (workflowDetail && workflowDetail.schedule) {
        const enabled = workflowDetail.schedule_enabled;
        const nextRun = workflowDetail.next_scheduled_at ? fmtDateTime(workflowDetail.next_scheduled_at) : 'Not calculated';
        const statusBadge = enabled ? '<span class="badge success">enabled</span>' : '<span class="badge pending">disabled</span>';
        scheduleHtml = `
          <div style="margin-bottom: 16px; padding: 12px; background: var(--panel-2); border: 1px solid var(--border); border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 6px;">
              <strong style="color: var(--accent-3);">⏰ Schedule:</strong>
              <code style="background: var(--panel); padding: 4px 8px; border-radius: 4px; font-family: 'JetBrains Mono', monospace;">${workflowDetail.schedule}</code>
              ${statusBadge}
            </div>
            ${enabled ? `<div style="color: var(--muted); font-size: 14px;">Next run: <strong style="color: var(--text);">${nextRun}</strong></div>` : ''}
          </div>
        `;
      }
      target.innerHTML = scheduleHtml + renderGraph(workflowGraph, {});
    }

    // simple layered DAG drawing
    function renderGraph(nodes, statusMap = {}) {
      if (!nodes.length) return '';
      const depsMap = Object.fromEntries(nodes.map(n => [n.id, n.deps || []]));
      const layerMap = {};
      function dfs(id) {
        if (layerMap[id] !== undefined) return layerMap[id];
        const deps = depsMap[id] || [];
        layerMap[id] = deps.length ? Math.max(...deps.map(d => dfs(d))) + 1 : 0;
        return layerMap[id];
      }
      nodes.forEach(n => dfs(n.id));
      const layers = {};
      Object.entries(layerMap).forEach(([id, layer]) => {
        layers[layer] = layers[layer] || [];
        layers[layer].push(id);
      });
      const layerKeys = Object.keys(layers).map(Number).sort((a, b) => a - b);
      const width = 160 * (layerKeys.length || 1);
      const height = 88 * Math.max(...Object.values(layers).map(v => v.length), 1);
      let svg = `<svg width="${width}" height="${height}" style="border:1px solid var(--border); border-radius:12px; background:#0f111a;">`;
      const positions = {};
      layerKeys.forEach((layer, idx) => {
        const items = layers[layer];
        items.forEach((id, i) => {
          const x = 90 + idx * 140;
          const y = 44 + i * 88;
          positions[id] = { x, y };
        });
      });
      nodes.forEach(n => {
        (n.deps || []).forEach(dep => {
          if (positions[dep] && positions[n.id]) {
            const a = positions[dep];
            const b = positions[n.id];
            svg += `<line x1="${a.x+34}" y1="${a.y}" x2="${b.x-34}" y2="${b.y}" stroke="#6ee7ff" stroke-width="2" marker-end="url(#arrow)"/>`;
          }
        });
      });
      svg += `<defs><marker id="arrow" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 z" fill="#6ee7ff"/></marker></defs>`;
      nodes.forEach(n => {
        const pos = positions[n.id];
        if (!pos) return;
        const status = (statusMap[n.id] || '').toLowerCase();
        const fill = status === 'success' ? '#12331b' :
                     status === 'running' || status === 'paused' || status === 'dispatched' ? '#2c2c1a' :
                     status === 'failed' || status === 'skipped' ? '#33181c' :
                     '#1b1f2c';
        const stroke = status === 'success' ? '#a7f3d0' :
                       status === 'running' || status === 'paused' || status === 'dispatched' ? '#fbd38d' :
                       status === 'failed' || status === 'skipped' ? '#ff6b6b' :
                       '#6ee7ff';
        svg += `<g>
          <rect x="${pos.x-44}" y="${pos.y-18}" rx="10" ry="10" width="88" height="36" fill="${fill}" stroke="${stroke}" stroke-width="2"></rect>
          <text x="${pos.x}" y="${pos.y+5}" fill="#e8ecf2" font-size="12" text-anchor="middle" font-family="Space Grotesk, sans-serif">${n.id}</text>
        </g>`;
      });
      svg += `</svg>`;
      return svg;
    }
    function renderPagination(prefix, currentPage, totalPages, onChange) {
      if (totalPages <= 1) {
        document.getElementById(`${prefix}-pagination`).innerHTML = '';
        return;
      }

      const prevDisabled = currentPage === 0;
      const nextDisabled = currentPage >= totalPages - 1;

      const buttons = [];
      if (!prevDisabled) {
        buttons.push(`<button onclick="this.blur()" style="padding: 4px 8px; background: var(--panel-2); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; color: var(--text);" data-page="${currentPage - 1}">Prev</button>`);
      }
      buttons.push(`<span style="padding: 0 8px; color: var(--muted);">Page ${currentPage + 1} of ${totalPages}</span>`);
      if (!nextDisabled) {
        buttons.push(`<button onclick="this.blur()" style="padding: 4px 8px; background: var(--panel-2); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; color: var(--text);" data-page="${currentPage + 1}">Next</button>`);
      }

      const container = document.getElementById(`${prefix}-pagination`);
      container.innerHTML = buttons.join(' ');
      container.querySelectorAll('button').forEach(btn => {
        btn.onclick = () => onChange(parseInt(btn.dataset.page));
      });
    }

    function updateWorkflowFilterOptions() {
      const select = document.getElementById('run-workflow-filter');
      const currentValue = select.value;
      const uniqueWorkflows = [...new Set(workflows.map(w => w.name))].sort();

      select.innerHTML = '<option value="">All workflows</option>' +
        uniqueWorkflows.map(name => `<option value="${name}">${name}</option>`).join('');

      if (currentValue && uniqueWorkflows.includes(currentValue)) {
        select.value = currentValue;
      }
    }
  </script>
</body>
</html>
